#!/bin/bash

set -eu
set -o pipefail

SCRIPT_SRC=${BASH_SOURCE[0]}
# Resolve $SCRIPT_SRC until the file is no longer a symlink.
while [ -L "$SCRIPT_SRC" ]; do
    SCRIPT_DIR=$(cd -P "$(dirname "$SCRIPT_SRC")" > /dev/null 2>&1 && pwd)
    SCRIPT_SRC=$(readlink "$SCRIPT_SRC")
    # If $SCRIPT_SRC was a relative symlink, we need to resolve it relative to the path
    # where the symlink file was located.
    [[ $SCRIPT_SRC != /* ]] && SCRIPT_SRC=$SCRIPT_DIR/$SCRIPT_SRC
done
SCRIPT_DIR=$(cd -P "$(dirname "$SCRIPT_SRC")" > /dev/null 2>&1 && pwd)

declare -r USER_HOME=/home/$SUDO_USER
declare -r USER_RC=$USER_HOME/.bashrc
declare -a path_additions=('"$HOME"/bin' '"$HOME"/.local/bin')

# ---------------------------------------------------------------------------
# Command wrappers -- tweak common flags (e.g. verbosity) in one place
# ---------------------------------------------------------------------------
_wget()     { wget -q "$@"; }
_cp()       { cp -v "$@"; }
_mkdir()    { mkdir -v "$@"; }
_chown()    { chown "$@"; }
_install()  { install -v "$@"; }
_apt_get()  { apt-get -qq "$@"; }

installUser() {
    local dest_dir
    local file_to_copy
    dest_dir=$1
    file_to_copy=${2:-}
    _mkdir -p "$dest_dir"
    _chown -R "$SUDO_USER":"$SUDO_USER" "$dest_dir"
    if [ -n "$file_to_copy" ]; then
        _install --owner "$SUDO_USER" --group "$SUDO_USER" -t "$dest_dir" "$file_to_copy"
    fi
}

in_wsl() {
    [ -e /proc/sys/fs/binfmt_misc/WSLInterop ]
}

banner() {
    echo
    echo "==== $* ===="
}

add_user_to_group() {
    local user=$1
    local group=$2
    if groups "$user" | grep -q "$group"; then
        echo "  Group '$group': already a member"
    else
        usermod -a -G "$group" "$user"
        echo "  Group '$group': added '$user'"
    fi
}

if [[ $EUID -ne 0 ]]; then
    echo "Error: this script must be run as root"
    exit 1
fi

if [ -z "${SUDO_USER:-}" ]; then
    echo "Error: SUDO_USER is blank, can't determine who called me" >&2
    exit 1
fi

if ! grep -q 'ubuntu' /etc/os-release; then
    echo "Error: this script only supports Ubuntu" >&2
    exit 1
fi

export DEBIAN_FRONTEND=noninteractive

# Preseed wireshark to allow non-root capture so the 'wireshark' group is created
echo "wireshark-common wireshark-common/install-setuid boolean true" | debconf-set-selections

# =============================================================================
banner "Bootstrap: install curl"
# =============================================================================

_apt_get update
_apt_get install -y curl

# =============================================================================
banner "Preparing apt sources"
# =============================================================================

declare -a docker_conflicts=()
for pkg in docker.io docker-doc docker-compose podman-docker containerd runc; do
    if dpkg-query -Wf'${db:Status-abbrev}' "$pkg" 2>/dev/null | grep -q '^i'; then
        docker_conflicts+=("$pkg")
    fi
done
if [ ${#docker_conflicts[@]} -gt 0 ]; then
    echo "  Removing conflicting Docker packages: ${docker_conflicts[*]}"
    _apt_get remove -y "${docker_conflicts[@]}"
else
    echo "  No conflicting Docker packages found"
fi

if ! in_wsl; then
    echo "  Adding Signal apt source..."
    wget -qO- https://updates.signal.org/desktop/apt/keys.asc \
        | gpg --batch --yes --dearmor -o /usr/share/keyrings/signal-desktop-keyring.gpg
    echo 'deb [arch=amd64 signed-by=/usr/share/keyrings/signal-desktop-keyring.gpg] https://updates.signal.org/desktop/apt xenial main' \
        > /etc/apt/sources.list.d/signal-xenial.list

    echo "  Adding 1Password apt source..."
    curl -sS https://downloads.1password.com/linux/keys/1password.asc \
        | gpg --batch --yes --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg
    echo 'deb [arch=amd64 signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/amd64 stable main' \
        > /etc/apt/sources.list.d/1password.list
    _mkdir -p /etc/debsig/policies/AC2D62742012EA22/
    curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol \
        > /etc/debsig/policies/AC2D62742012EA22/1password.pol
    _mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22
    curl -sS https://downloads.1password.com/linux/keys/1password.asc \
        --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg
fi

echo "  Adding Docker apt source..."
_install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
    | gpg --batch --yes --dearmor -o /etc/apt/keyrings/docker.gpg
chmod a+r /etc/apt/keyrings/docker.gpg
rm -f /etc/apt/sources.list.d/docker.list
echo \
    "deb [arch=$(dpkg --print-architecture)" \
    'signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu' \
    "$(. /etc/os-release && echo "$VERSION_CODENAME") stable" > \
    /etc/apt/sources.list.d/docker.list

echo "  Adding google-drive-ocamlfuse PPA..."
add-apt-repository --no-update -y ppa:alessandro-strada/ppa > /dev/null 2>&1

declare -a deb_files=()
if ! in_wsl && ! command -v discord > /dev/null; then
    echo "  Downloading Discord .deb..."
    _wget -O /tmp/discord.deb 'https://discordapp.com/api/download?platform=linux&format=deb'
    deb_files+=(/tmp/discord.deb)
fi

# =============================================================================
banner "Installing packages"
# =============================================================================

echo "  Updating package lists..."
_apt_get update
echo "  Upgrading installed packages..."
_apt_get upgrade -y
echo "  Installing packages..."

declare -a packages=(
    apt-show-versions
    aptitude
    asciinema
    atool
    autoconf
    autopoint
    autossh
    autotools-dev
    bison
    btop
    build-essential
    can-utils
    ccache
    clang
    clang-format
    clangd
    cmake
    containerd.io
    cppcheck
    cscope
    curl
    ddd
    device-tree-compiler
    dkms
    docker-buildx-plugin
    docker-ce
    docker-ce-cli
    docker-compose-plugin
    dos2unix
    dpkg-dev
    efibootmgr
    exuberant-ctags
    fd-find
    flex
    fzf
    gawk
    gcc-multilib
    gdb-multiarch
    gnome-tweaks
    google-drive-ocamlfuse
    gparted
    graphviz
    groff
    htop
    hwinfo
    icoutils
    imagemagick
    indent
    inotify-tools
    iperf3
    jq
    jsonlint
    lbzip2
    libssl-dev
    libvirt-clients
    libvirt-dev
    linux-tools-generic
    lua5.1
    luarocks
    meson
    nasm
    net-tools
    nfs-kernel-server
    ninja-build
    nmap
    openjdk-8-jdk
    openjdk-8-jdk-headless
    openssh-server
    p7zip-full
    parted
    pbzip2
    picocom
    pigz
    pipx
    pkg-config
    pre-commit
    protobuf-compiler
    pv
    python3-pip
    python3-stestr
    python3-venv
    qemu-system
    qemu-system-x86
    qemu-user-static
    remake
    ripgrep
    rlwrap
    rpm
    ruby
    ruby-dev
    samba
    shellcheck
    shfmt
    smbclient
    socat
    speedtest-cli
    sshfs
    sshpass
    strace
    texinfo
    tmate
    tmux
    tree
    tshark
    usbutils
    uuid
    uuid-dev
    valgrind
    vim
    vite
    virtualenv
    whois
    wireguard
    wireguard-tools
    wireshark
    xsel
    yamllint
    zip
    zlib1g-dev
    zstd
)

if ! in_wsl; then
    packages+=(signal-desktop 1password)
fi

_apt_get install -y "${packages[@]}" ${deb_files[@]+"${deb_files[@]}"}
for f in "${deb_files[@]+"${deb_files[@]}"}"; do rm -f "$f"; done

# =============================================================================
banner "Installing additional tools"
# =============================================================================

if command -v direnv > /dev/null; then
    echo "  direnv: already installed"
else
    echo "  direnv: installing..."
    arch=$(uname -m)
    case "$arch" in
        x86_64)  arch="amd64" ;;
        aarch64) arch="arm64" ;;
        *) echo "Unsupported architecture: $arch"; exit 1 ;;
    esac
    latest=$(curl -sS https://api.github.com/repos/direnv/direnv/releases/latest | jq -r '.tag_name')
    if [ -z "$latest" ] || [ "$latest" = "null" ]; then
        echo "Error determining latest direnv version!"
        exit 1
    fi
    curl -sSL -o /usr/local/bin/direnv \
        "https://github.com/direnv/direnv/releases/download/${latest}/direnv.linux-${arch}"
    chmod +x /usr/local/bin/direnv
fi

if command -v starship > /dev/null; then
    echo "  Starship: already installed"
else
    echo "  Starship: installing..."
    sh <(curl -sS https://starship.rs/install.sh) -y
fi

if in_wsl; then
    echo "  Brave: skipped (WSL)"
elif command -v brave-browser > /dev/null; then
    echo "  Brave: already installed"
else
    echo "  Brave: installing..."
    curl -fsS https://dl.brave.com/install.sh | sh
fi

if in_wsl; then
    echo "  Slack: skipped (WSL)"
elif command -v slack > /dev/null; then
    echo "  Slack: already installed"
else
    echo "  Slack: installing..."
    snap install slack
fi

if in_wsl; then
    echo "  Saleae Logic2: skipped (WSL)"
elif dpkg-query -Wf'${db:Status-abbrev}' saleae-logic2 2>/dev/null | grep -q '^i'; then
    echo "  Saleae Logic2: already installed"
else
    echo "  Saleae Logic2: installing..."
    tmp=$(mktemp -d)
    git clone https://github.com/pdietl/saleae-logic2-appimage-to-deb.git "$tmp"
    pushd "$tmp" > /dev/null
    ./build-logic2-deb.sh
    deb_file=$(ls -1 "$tmp"/saleae-logic2_*.deb 2>/dev/null | head -1)
    if [ -n "$deb_file" ]; then
        _apt_get install -y "$deb_file"
        rm "$deb_file"
    else
        echo "Error: Saleae deb file not found!"
        exit 1
    fi
    popd > /dev/null
    rm -rf "$tmp"
fi

if command -v aws > /dev/null; then
    echo "  awscli: already installed"
else
    echo "  awscli: installing..."
    tmp=$(mktemp -d)
    pushd "$tmp" > /dev/null
    curl -sS "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    unzip -q awscliv2.zip
    ./aws/install
    popd > /dev/null
    rm -rf "$tmp"
fi

if [ -e "$USER_HOME/.nvm_installed" ]; then
    echo "  NVM + node: already installed"
else
    nvm_latest=$(curl -sS https://api.github.com/repos/nvm-sh/nvm/releases/latest | jq -r '.tag_name')
    if [ -z "$nvm_latest" ] || [ "$nvm_latest" = "null" ]; then
        echo "Error determining latest NVM version!"
        exit 1
    fi
    echo "  NVM $nvm_latest + node: installing..."
    sudo -u "$SUDO_USER" bash -c "curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/$nvm_latest/install.sh | bash"
    sudo -u "$SUDO_USER" bash -c "export NVM_DIR='$USER_HOME/.nvm' && source \"\$NVM_DIR/nvm.sh\" && nvm install node"
    touch "$USER_HOME/.nvm_installed"
    _chown "$SUDO_USER:$SUDO_USER" "$USER_HOME/.nvm_installed"
fi

if command -v nvim > /dev/null; then
    echo "  Neovim: already installed"
else
    echo "  Neovim: installing..."
    _wget -O /tmp/nvim.tgz https://github.com/neovim/neovim/releases/latest/download/nvim-linux-$(uname -m).tar.gz
    tar -C /usr/local --strip-components 1 -xzf /tmp/nvim.tgz
    rm /tmp/nvim.tgz
    installUser "$USER_HOME"/.config/nvim
    _cp -r "$SCRIPT_DIR"/nvim/* "$USER_HOME"/.config/nvim
    _chown -R "$SUDO_USER":"$SUDO_USER" "$USER_HOME"/.config/nvim
fi

if [ -e "$USER_HOME"/.cargo/env ]; then
    echo "  Rust: already installed"
else
    echo "  Rust: installing..."
    sudo -u "$SUDO_USER" -- curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs |
        sudo -u "$SUDO_USER" -- sh -s -- -y --no-modify-path
    path_additions+=('"$HOME"/.cargo/bin')
fi

if [ -e /usr/local/go ]; then
    echo "  Go: already installed"
else
    echo "  Go: installing..."
    latest=$(wget -nv -O- https://go.dev/dl/ 2>/dev/null)
    latest=$(grep -oP -m1 'go(\d+\.){3}linux-amd64\.tar\.gz' - <<< "$latest")
    if [ -z "$latest" ]; then
        echo "Error determining latest Go version!"
        exit 1
    fi
    _wget "https://go.dev/dl/$latest"
    rm -rf /usr/local/go
    tar -C /usr/local -xzf "$latest"
    _mkdir -p "$USER_HOME"/go/{bin,pkg,src}
    echo $'\n''export GOPATH=$HOME/go'$'\n' >> "$USER_RC"
    path_additions+=('/usr/local/go/bin' '"$GOPATH"/bin')
    rm "$latest"
    echo "  Go: $(/usr/local/go/bin/go version)"
fi

if command -v bazelisk > /dev/null; then
    echo "  Bazelisk: already installed"
else
    arch=$(uname -m)
    case "$arch" in
        x86_64) arch="amd64" ;;
        aarch64) arch="arm64" ;;
        *) echo "Unsupported architecture: $arch"; exit 1 ;;
    esac
    latest=$(curl -sS https://api.github.com/repos/bazelbuild/bazelisk/releases/latest | jq -r '.tag_name')
    if [ -z "$latest" ] || [ "$latest" = "null" ]; then
        echo "Error determining latest Bazelisk version!"
        exit 1
    fi
    echo "  Bazelisk $latest: installing..."
    _wget -O /usr/local/bin/bazelisk "https://github.com/bazelbuild/bazelisk/releases/download/${latest}/bazelisk-linux-${arch}"
    chmod +x /usr/local/bin/bazelisk
    ln -sf /usr/local/bin/bazelisk /usr/local/bin/bazel
fi

if [ -e /etc/.nix-installed ]; then
    echo "  Nix: already installed"
else
    echo "  Nix: installing..."
    printf 'n\ny\n' | sh <(curl -L https://nixos.org/nix/install) --daemon 2>&1 | grep -E '^\~\~>|error|warning' | grep -v 'is greater than SYS_UID_MAX' || true
    echo "trusted-users = $SUDO_USER" >> /etc/nix/nix.conf
    installUser "$USER_HOME/.config/nix" "$SCRIPT_DIR/nix.conf"
    touch /etc/.nix-installed
fi

if in_wsl; then
    echo "  Nerd Font: skipped (WSL)"
elif [ -e "$USER_HOME/.fonts/0xProtoNerdFontMono-Regular.ttf" ]; then
    echo "  Nerd Font: already installed"
else
    nerdfont_latest=$(curl -sS https://api.github.com/repos/ryanoasis/nerd-fonts/releases/latest | jq -r '.tag_name')
    if [ -z "$nerdfont_latest" ] || [ "$nerdfont_latest" = "null" ]; then
        echo "Error determining latest Nerd Font version!"
        exit 1
    fi
    echo "  0xProto Nerd Font $nerdfont_latest: installing..."
    _wget -O /tmp/nerdfont.zip "https://github.com/ryanoasis/nerd-fonts/releases/download/${nerdfont_latest}/0xProto.zip"
    _mkdir -p "$USER_HOME"/.fonts
    aunpack --extract-to "$USER_HOME"/.fonts /tmp/nerdfont.zip
    rm /tmp/nerdfont.zip
    rm "$USER_HOME"/.fonts/{LICENSE,README.md}
    _chown "$SUDO_USER:$SUDO_USER" -R "$USER_HOME"/.fonts
    profile=$(gsettings get org.gnome.Terminal.ProfilesList default)
    profile=${profile:1:-1} # remove leading and trailing single quotes
    gsettings set "org.gnome.Terminal.Legacy.Profile:/org/gnome/terminal/legacy/profiles:/:$profile/" font '0xProto Nerd Font 14'
fi

# =============================================================================
banner "Setting up Docker"
# =============================================================================

systemctl is-active --quiet docker || sleep 5
add_user_to_group "$SUDO_USER" docker
echo "  Sanity check as '$SUDO_USER'..."
if ! su -c 'docker run hello-world' "$SUDO_USER" > /dev/null 2>&1; then
    echo "ERROR: Docker is misconfigured. Please contact a human for help."
    exit 1
fi
echo "  Docker: OK"

# =============================================================================
banner "Configuring system"
# =============================================================================

echo "  Sudoers: passwordless sudo"
sed -i 's/^%sudo.*/%sudo ALL=NOPASSWD: ALL/' /etc/sudoers

if [ -e "/home/$SUDO_USER/.vimrc" ]; then
    echo "  vimrc: already installed"
else
    echo "  vimrc: installing"
    _cp "$SCRIPT_DIR"/vimrc "$USER_HOME"/.vimrc
    _chown "$SUDO_USER":"$SUDO_USER" "$USER_HOME"/.vimrc
    installUser "$USER_HOME"/.vim/pack/plugins/start/cscope/plugin/ "$SCRIPT_DIR"/cscope_maps.vim
    installUser "$USER_HOME"/.vim/spell
fi

if [ -e "/home/$SUDO_USER/.tmux.conf" ]; then
    echo "  tmux.conf: already installed"
else
    echo "  tmux.conf: installing"
    _cp "$SCRIPT_DIR"/tmux.conf "$USER_HOME"/.tmux.conf
    _chown "$SUDO_USER":"$SUDO_USER" "$USER_HOME"/.tmux.conf
fi

echo "  Cleaning up home directories..."
rm -rf "$USER_HOME"/{Public,Templates,Music}
declare -a dir_list=(
    "$USER_HOME"/Applications
    "$USER_HOME"/Downloads
    "$USER_HOME"/GoogleDrive
    "$USER_HOME"/Learn
    "$USER_HOME"/Repos
)
_mkdir -p "${dir_list[@]}"
_chown "$SUDO_USER:$SUDO_USER" -R "${dir_list[@]}"

declare -r KEY_TYPE=ed25519
declare -r KEY_PATH=/home/$SUDO_USER/.ssh/id_$KEY_TYPE
if [ -e "$KEY_PATH" ]; then
    echo "  SSH key: already generated"
else
    echo "  SSH key: generating $KEY_TYPE keypair"
    sudo -H -u "$SUDO_USER" ssh-keygen -t "$KEY_TYPE" -N '' -f "$KEY_PATH"
fi

echo "  Git remote: updating origin to SSH"
(cd "$SCRIPT_DIR" && git remote set-url origin git@github.com:pdietl/dev_tools.git)

declare -r BIN_DEST=$USER_HOME/bin
if [ -e "$BIN_DEST" ]; then
    echo "  User binaries: already installed"
else
    echo "  User binaries: installing to $BIN_DEST"
    _mkdir -p "$BIN_DEST"
    _cp -r "$SCRIPT_DIR"/bin/* "$BIN_DEST"
    _chown "$SUDO_USER:$SUDO_USER" -R "$BIN_DEST"
fi

if [ -e "$USER_HOME/.gitconfig" ]; then
    echo "  gitconfig: already installed"
else
    echo "  gitconfig: installing"
    echo '[user]
    name = Pete Dietl
    email = petedietl@gmail.com
[core]
    editor = vim
    excludesfile = ~/.gitignore_global
[init]
    defaultBranch = main' > "$USER_HOME/.gitconfig"
    _chown "$SUDO_USER:$SUDO_USER" "$USER_HOME/.gitconfig"
    _cp "$SCRIPT_DIR"/gitignore_global "$USER_HOME"/.gitignore_global
    _chown "$SUDO_USER:$SUDO_USER" "$USER_HOME"/.gitignore_global
fi

add_user_to_group "$SUDO_USER" dialout
add_user_to_group "$SUDO_USER" plugdev
# Reconfigure wireshark-common to ensure the 'wireshark' group exists
# (needed if it was previously installed without the preseed)
dpkg-reconfigure wireshark-common
add_user_to_group "$SUDO_USER" wireshark

gsettings_set() {
    local schema=$1
    local key=$2
    local value=$3
    sudo -H -u "$SUDO_USER" \
        DISPLAY=:0 \
        DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/"$(id -u "$SUDO_USER")"/bus \
        gsettings set "$schema" "$key" "$value"
}

if in_wsl; then
    echo "  GNOME: skipped (WSL)"
elif command -v gsettings > /dev/null; then
    echo "  GNOME: configuring settings"
    gsettings_set org.gnome.desktop.interface clock-format 12h
    favorite_apps="[
        'brave-browser.desktop',
        'org.gnome.Nautilus.desktop',
        'signal-desktop.desktop',
        'discord.desktop',
        'slack_slack.desktop'
    ]"
    gsettings_set org.gnome.shell favorite-apps "$favorite_apps"
    gsettings_set org.gnome.desktop.peripherals.touchpad click-method fingers
else
    echo "  GNOME: not present, skipping"
fi

echo "  udev rules: installing"
_cp "$SCRIPT_DIR"/udev_rules/* /etc/udev/rules.d/
udevadm control --reload

echo "  gdbinit: installing"
_cp "$SCRIPT_DIR"/gdbinit "$USER_HOME"/.gdbinit
_chown "$SUDO_USER":"$SUDO_USER" "$USER_HOME"/.gdbinit

# =============================================================================
banner "Finalizing"
# =============================================================================

echo "  Cleaning up unused packages..."
_apt_get autoremove -y

declare -r PATH_SETTINGS_BANNER='# PATH Additions'
if [ -e "$USER_RC" ] && grep -q -F "$PATH_SETTINGS_BANNER" "$USER_RC"; then
    echo "  Shell paths/prompt: already configured"
else
    echo "  Shell paths/prompt: configuring"
    cat "$SCRIPT_DIR"/dedup_paths.sh >> "$USER_RC"
    (
        echo "$PATH_SETTINGS_BANNER"
        for addition in "${path_additions[@]}"; do
            echo "prepend_path $addition"
        done
        echo
        echo 'dedup_paths'
        echo
        echo "PS1='\w$ '"
        echo
        echo 'eval "$(direnv hook bash)"'
        echo 'eval "$(starship init bash)"'
    ) >> "$USER_RC"
    _chown "$SUDO_USER:$SUDO_USER" -R "$USER_HOME"/.bashrc
    installUser "$USER_HOME"/.config "$SCRIPT_DIR"/starship.toml
fi

echo
echo "Done!"
